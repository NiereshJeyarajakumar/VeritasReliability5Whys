<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>RCA Timeline + 5 Why Tool — Veritas Reliability</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ========== Base Layout ========== */
body {
  font-family: Arial, sans-serif;
  background: #fff;
  color: #000;
  max-width: 1000px;
  margin: 40px auto;
}
.card {
  border: 1px solid #000;
  border-radius: 10px;
  padding: 20px;
  background: #fff;
  margin-top: 20px;
}

/* ========== Buttons ========== */
button {
  background: #C2965B;
  color: #000;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  font-weight: 400;
  cursor: pointer;
  margin: 6px 6px 0 0;
}
button:hover { opacity: .9; }
#newRCA {
  background: #0B1C36;
  color: #C2965B;
}

/* ========== Headers ========== */
.header {
  background: #0B1C36;
  color: #C2965B;
  font-weight: bold;
  text-align: center;
  padding: 10px;
  border-radius: 8px 8px 0 0;
  font-size: 16px;
}

/* ========== Timeline Layout ========== */
.timeline-wrapper {
  margin-top: 25px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 30px;
  width: 100%;
  overflow-x: auto;
  padding-bottom: 10px;
}

.timeline-row {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
  width: 100%;
  margin-top: 10px;
}

.event {
  position: relative;
  width: 220px;
  max-width: 220px;
  text-align: center;
  flex-shrink: 0;
}

.event textarea {
  min-height: 90px;
  border: 2px solid #0B1C36;
  border-radius: 6px;
  padding: 10px;
  resize: vertical;
  box-sizing: border-box;
}

.event::after {
  content: "→";
  position: absolute;
  top: 50%;
  right: -18px;
  transform: translateY(-50%);
  font-weight: bold;
  font-size: 20px;
  color: #000;
}

/* Hide arrow after last event */
#preGrid .timeline-row:last-child .event:last-child::after,
#postGrid .timeline-row:last-child .event:last-child::after {
  content: "";
}

.delete-btn {
  position: absolute;
  top: 2px;
  right: 4px;
  background: transparent;
  color: #666;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
.delete-btn:hover { color: #C2965B; }

/* ========== Failure ========== */
.failure-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
.failure-arrow {
  font-size: 22px;
  font-weight: bold;
}
.failure {
  background: #0B1C36;
  color: #C2965B;
  font-weight: 700;
  border-radius: 10px;
  padding: 12px;
  width: 220px;
  text-align: center;
}
.failure textarea {
  margin-top: 6px;
  min-height: 90px;
}

/* ========== Event Details ========== */
.details-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-top: 12px;
  align-items: start;
}
.details-grid label {
  font-weight: 700;
  margin-bottom: 6px;
  display: block;
  color: #0B1C36;
}
.details-grid input {
  width: 100%;
  height: 42px;
  padding: 8px 10px;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  background: #fff;
  box-sizing: border-box;
}

/* ========== General textareas ========== */
textarea {
  width: 100%;
  min-height: 60px;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  padding: 8px 10px;
  resize: vertical;
  font-size: 14px;
  box-sizing: border-box;
}

/* ========== Table Styling ========== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
th {
  background: #C2965B;
  color: #0B1C36;
  font-weight: 700;
}
td {
  border: 1px solid #000;
  padding: 8px;
  vertical-align: top;
}

/* ✅ EXACT 40px header height for WHY table */
#whyCard table thead th {
  height: 40px !important;
  padding-top: 8px !important;
  padding-bottom: 8px !important;
  vertical-align: middle !important;
  line-height: 1.2;
}

/* ✅ EXACT 40px header height for Actions table */
#actionsTable thead th {
  height: 40px !important;
  padding-top: 8px !important;
  padding-bottom: 8px !important;
  vertical-align: middle !important;
  line-height: 1.2;
}

/* ✅ ACTIONS TABLE COLUMN WIDTH FIX */
#actionsTable th:first-child,
#actionsTable td:first-child {
  width: 6%;
  text-align: center;
}

#actionsTable th:nth-child(2),
#actionsTable td:nth-child(2) {
  width: 56%;
}

#actionsTable th:nth-child(3),
#actionsTable td:nth-child(3) {
  width: 12%;
  text-align: center;
}

#actionsTable th:nth-child(4),
#actionsTable td:nth-child(4) {
  width: 12%;
  text-align: center;
}

#actionsTable th:nth-child(5),
#actionsTable td:nth-child(5) {
  width: 12%;
  text-align: center;
}

#actionsTable th:nth-child(6),
#actionsTable td:nth-child(6) {
  width: 2%;
  text-align: center;
}

.delete-action {
  background: transparent;
  border: none;
  color: #C2965B;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
}
.delete-action:hover { color: #000; }
</style>
</head>

<body>

<!-- TIMELINE -->
<div class="card">
  <div class="header">Event Timeline</div>

  <button id="addPre">Add Pre-Event</button>
  <button id="clearPre">Clear All Pre-Events</button>
  <button id="addPost">Add Post-Event</button>
  <button id="clearPost">Clear All Post-Events</button>
  <button id="exportPDF">Download RCA as PDF</button>
  <button id="newRCA">New RCA</button>

  <div class="timeline-wrapper">
    <div id="preGrid"></div>

    <div class="failure-wrapper">
      <div class="failure-arrow">→</div>
      <div class="failure">
        Failure / Defect<br><small>(Event 0)</small>
        <textarea id="failureDesc" placeholder="Describe failure or defect..."></textarea>
      </div>
      <div class="failure-arrow">→</div>
    </div>

    <div id="postGrid"></div>
  </div>
</div>

<!-- DETAILS -->
<div id="detailsCard" class="card">
  <div class="header">Event Details</div>
  <div class="details-grid">
    <div><label>Date</label><input type="date"></div>
    <div><label>Time</label><input type="time"></div>
    <div><label>Plant / Unit ID</label><input type="text"></div>
    <div><label>Duration (hrs)</label><input type="number" step="0.1"></div>
  </div>
</div>

<!-- WHY -->
<div id="whyCard" class="card">
  <div class="header">Problem / Defect</div>
  <textarea id="problem" placeholder="Describe the problem or defect..."></textarea>

  <table>
    <thead>
      <tr>
        <th>WHY Level</th>
        <th>What caused the specific situation?</th>
        <th>Why wasn’t the problem detected?</th>
        <th>What system(s) failed?</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>1st WHY?</td><td><textarea></textarea></td><td><textarea></textarea></td><td><textarea></textarea></td></tr>
      <tr><td>2nd WHY?</td><td><textarea></textarea></td><td><textarea></textarea></td><td><textarea></textarea></td></tr>
      <tr><td>3rd WHY?</td><td><textarea></textarea></td><td><textarea></textarea></td><td><textarea></textarea></td></tr>
      <tr><td>4th WHY?</td><td><textarea></textarea></td><td><textarea></textarea></td><td><textarea></textarea></td></tr>
      <tr><td>5th WHY?</td><td><textarea></textarea></td><td><textarea></textarea></td><td><textarea></textarea></td></tr>
    </tbody>
  </table>
</div>

<!-- ACTIONS -->
<div class="card">
  <div class="header">Actions & Recommendations</div>

  <table id="actionsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Actions / Recommendations</th>
        <th>Value</th>
        <th>Complexity</th>
        <th>Urgency</th>
        <th>Del</th>
      </tr>
    </thead>
    <tbody id="actionsBody">
      <tr>
        <td>1</td>
        <td><textarea></textarea></td>
        <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
        <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
        <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
        <td><button class="delete-action">×</button></td>
      </tr>
    </tbody>
  </table>

  <button id="addRow">Add Row</button>
</div>

<script>
/* ============================ TIMELINE LOGIC ============================ */

const preGrid = document.getElementById("preGrid");
const postGrid = document.getElementById("postGrid");
let preCount = 0;
let postCount = 0;

function createRow() {
  const row = document.createElement("div");
  row.className = "timeline-row";
  return row;
}

function createEvent(label, type) {
  const div = document.createElement("div");
  div.className = "event";
  div.innerHTML = `
    <button class="delete-btn">×</button>
    <strong>${label}</strong><br>
    <textarea placeholder="Describe event..."></textarea>
  `;
  div.querySelector(".delete-btn").addEventListener("click", () => {
    const row = div.parentElement;
    div.remove();
    if (row && row.querySelectorAll(".event").length === 0) row.remove();
    renumberEvents(type);
  });
  return div;
}

function addEvent(grid, type) {
  let rows = grid.querySelectorAll(".timeline-row");
  let row = rows[rows.length - 1];

  if (!row || row.querySelectorAll(".event").length >= 3) {
    row = createRow();
    grid.appendChild(row);
  }

  const eventNumber = type === "pre" ? ++preCount : ++postCount;
  row.appendChild(createEvent(`${type === "pre" ? "Pre-Event" : "Post-Event"} ${eventNumber}`, type));
}

document.getElementById("addPre").addEventListener("click", () => addEvent(preGrid, "pre"));
document.getElementById("addPost").addEventListener("click", () => addEvent(postGrid, "post"));

document.getElementById("clearPre").addEventListener("click", () => {
  if (confirm("Clear all Pre-Events?")) {
    preGrid.innerHTML = "";
    preCount = 0;
  }
});
document.getElementById("clearPost").addEventListener("click", () => {
  if (confirm("Clear all Post-Events?")) {
    postGrid.innerHTML = "";
    postCount = 0;
  }
});

function renumberEvents(type) {
  const grid = type === "pre" ? preGrid : postGrid;
  [...grid.querySelectorAll(".event strong")].forEach((label, i) => {
    label.textContent = `${type === "pre" ? "Pre-Event" : "Post-Event"} ${i + 1}`;
  });
  if (type === "pre") preCount = grid.querySelectorAll(".event").length;
  else postCount = grid.querySelectorAll(".event").length;
}

/* ============================ RESET LOGIC ============================ */

document.getElementById("newRCA").addEventListener("click", () => {
  if (!confirm("Start a new RCA?")) return;

  preGrid.innerHTML = "";
  postGrid.innerHTML = "";
  preCount = 0;
  postCount = 0;

  document.getElementById("failureDesc").value = "";
  document.querySelectorAll("#detailsCard input").forEach(i => i.value = "");
  document.querySelectorAll("#whyTable textarea").forEach(t => t.value = "");
  document.getElementById("problem").value = "";

  actionsBody.innerHTML = `
    <tr>
      <td>1</td>
      <td><textarea></textarea></td>
      <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
      <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
      <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
      <td><button class="delete-action">×</button></td>
    </tr>`;
  updateDeleteButtons();
  alert("RCA has been reset.");
});

/* ============================ PDF EXPORT ============================ */

document.getElementById("exportPDF").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "a4");
  const margin = 20;
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgWidth = pageWidth - margin * 2;

  async function addSection(section) {
    const canvas = await html2canvas(section, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 40;

    pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
    heightLeft -= (pdf.internal.pageSize.getHeight() - position);

    while (heightLeft > 0) {
      pdf.addPage();
      position = heightLeft - imgHeight + 40;
      pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
      heightLeft -= pdf.internal.pageSize.getHeight();
    }
  }

  /* ========== PAGE 1: TIMELINE ========== */
  const tClone = document.querySelector(".timeline-wrapper").closest(".card").cloneNode(true);
  const tWrap = document.createElement("div");
  tWrap.style.background = "#fff";
  tWrap.style.padding = "20px";
  tWrap.appendChild(tClone);
  document.body.appendChild(tWrap);
  await addSection(tWrap);
  tWrap.remove();

  /* ========== PAGE 2: DETAILS + WHY ========== */
  pdf.addPage();
  const page2 = document.createElement("div");
  page2.style.background = "#fff";
  page2.style.padding = "20px";
  page2.appendChild(document.getElementById("detailsCard").cloneNode(true));
  page2.appendChild(document.getElementById("whyCard").cloneNode(true));
  document.body.appendChild(page2);
  await addSection(page2);
  page2.remove();

  /* ========== PAGE 3: ACTIONS ONLY ========== */
  pdf.addPage();
  const page3 = document.createElement("div");
  page3.style.background = "#fff";
  page3.style.padding = "20px";
  page3.appendChild(document.querySelector(".card:last-of-type").cloneNode(true));
  document.body.appendChild(page3);
  await addSection(page3);
  page3.remove();

  pdf.save("Veritas_RCA_Full.pdf");
});

/* ============================ ACTIONS TABLE ============================ */

const actionsBody = document.getElementById("actionsBody");

document.getElementById("addRow").onclick = () => {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td></td>
    <td><textarea></textarea></td>
    <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
    <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
    <td><select><option></option><option>High</option><option>Medium</option><option>Low</option></select></td>
    <td><button class="delete-action">×</button></td>
  `;
  actionsBody.appendChild(row);
  updateDeleteButtons();
  renumberRows();
};

function updateDeleteButtons() {
  actionsBody.querySelectorAll(".delete-action").forEach(btn => {
    btn.onclick = () => {
      btn.closest("tr").remove();
      renumberRows();
    };
  });
}

function renumberRows() {
  [...actionsBody.rows].forEach((row, i) => {
    row.cells[0].textContent = i + 1;
  });
}

updateDeleteButtons();
renumberRows();
</script>

<!-- =======================================
     AUTO-RESIZE SCRIPT FOR WORDPRESS IFRAME
======================================= -->
<script>
(function () {
  function measureHeight() {
    const d = document;
    return Math.max(
      d.body.scrollHeight,
      d.documentElement.scrollHeight,
      d.body.offsetHeight,
      d.documentElement.offsetHeight,
      d.body.clientHeight,
      d.documentElement.clientHeight
    );
  }
  function postHeight() {
    try {
      const height = measureHeight();
      window.parent.postMessage(
        { type: "veritas-rca-height", height: height },
        "*"
      );
    } catch (e) {}
  }
  window.addEventListener("load", postHeight);

  if ("ResizeObserver" in window) {
    const ro = new ResizeObserver(() => postHeight());
    ro.observe(document.body);
  }

  let lastHeight = 0;
  setInterval(() => {
    const newHeight = document.body.scrollHeight;
    if (Math.abs(newHeight - lastHeight) > 10) {
      lastHeight = newHeight;
      postHeight();
    }
  }, 800);
})();
</script>

</body>
</html>
